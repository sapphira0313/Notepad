<!doctype html>
<html lang="zh-CN" class="bg-neutral-50 text-neutral-900 dark:bg-neutral-900 dark:text-neutral-100">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Notion记事本</title>
<link rel="icon" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' rx='18' fill='%23000'/%3E%3Ctext x='50' y='62' font-size='62' text-anchor='middle' fill='%23fff' font-family='Arial, Helvetica, sans-serif'%3EN%3C/text%3E%3C/svg%3E"/>
<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
<style>
html, body { height: 100%; }
.scrollbar-thin { scrollbar-width: thin; }
.scrollbar-thin::-webkit-scrollbar { width: 8px; height: 8px; }
.scrollbar-thin::-webkit-scrollbar-thumb { background: #d1d5db; border-radius: 8px; }
.scrollbar-thin::-webkit-scrollbar-track { background: transparent; }
</style>
</head>
<body class="h-full bg-neutral-50 text-neutral-900 dark:bg-neutral-900 dark:text-neutral-100">
<div class="h-full grid grid-cols-1 md:grid-cols-[300px_1fr]">
<aside class="border-r border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 flex flex-col min-h-0">
<div class="px-4 pt-4 pb-3 border-b border-neutral-200 dark:border-neutral-700">
<h1 class="text-xl font-semibold">Notion记事本</h1>
<p class="text-sm text-neutral-500 dark:text-neutral-400">临时记事 · 本地保存</p>
<div class="mt-3 flex gap-2 flex-wrap">
<button id="newBtn" class="px-3 py-1.5 text-sm rounded-xl bg-black text-white hover:opacity-90">新建</button>
<button id="exportBtn" class="px-3 py-1.5 text-sm rounded-xl border border-neutral-300 dark:border-neutral-600 hover:bg-neutral-50 dark:hover:bg-neutral-700">导出 Markdown</button>
<label class="px-3 py-1.5 text-sm rounded-xl border border-neutral-300 dark:border-neutral-600 hover:bg-neutral-50 dark:hover:bg-neutral-700 cursor-pointer">
导入<input id="importInput" type="file" accept=".md" class="hidden" />
</label>
<button id="themeToggle" class="px-3 py-1.5 text-sm rounded-xl border border-neutral-300 dark:border-neutral-600 hover:bg-neutral-50 dark:hover:bg-neutral-700">切换主题</button>
</div>
</div>
<div class="p-3">
<div class="relative">
<input id="search" placeholder="搜索标题或内容…" class="w-full rounded-xl border border-neutral-300 dark:border-neutral-600 px-3 py-2 pr-9 text-sm focus:outline-none focus:ring-2 focus:ring-neutral-900 dark:focus:ring-neutral-200 bg-white dark:bg-neutral-800 text-neutral-900 dark:text-neutral-100"/>
<span class="absolute right-3 top-1/2 -translate-y-1/2 text-neutral-400">⌘K</span>
</div>
</div>
<nav id="list" class="flex-1 overflow-auto p-2 space-y-1 scrollbar-thin" aria-label="Notes list"></nav>
<div class="p-3 text-xs text-neutral-400 border-t border-neutral-200 dark:border-neutral-700">
本地存储 · 无需登录 · 可分享链接
</div>
</aside>
<main class="min-h-0 flex flex-col">
<header class="p-4 border-b border-neutral-200 dark:border-neutral-700 bg-white dark:bg-neutral-800 flex items-center gap-2 flex-wrap">
<input id="title" class="text-lg md:text-xl font-semibold flex-1 min-w-[200px] outline-none bg-transparent border-b border-transparent focus:border-neutral-900 dark:focus:border-neutral-200" placeholder="无标题文档" />
<div class="flex items-center gap-2">
<button id="previewToggle" class="px-3 py-1.5 text-sm rounded-xl border border-neutral-300 dark:border-neutral-600 hover:bg-neutral-50 dark:hover:bg-neutral-700">预览 Markdown</button>
<button id="shareBtn" class="px-3 py-1.5 text-sm rounded-xl bg-black text-white hover:opacity-90">复制分享链接</button>
<button id="deleteBtn" class="px-3 py-1.5 text-sm rounded-xl border border-red-200 text-red-600 hover:bg-red-50 dark:hover:bg-red-900/30">删除</button>
</div>
</header>
<section class="flex-1 grid grid-rows-1 md:grid-cols-2 gap-0">
<textarea id="editor" class="md:col-span-2 h-full w-full p-4 resize-none outline-none bg-neutral-50 dark:bg-neutral-900 focus:bg-white dark:focus:bg-neutral-800 text-neutral-900 dark:text-neutral-100" placeholder="# 写点什么吧…\n\n- 支持 Markdown\n- 自动保存到浏览器本地\n- 点击右上角复制分享链接\n- 左侧可管理多笔记"></textarea>
<article id="preview" class="hidden prose prose-neutral dark:prose-invert max-w-none p-6 overflow-auto bg-white dark:bg-neutral-800 border-t md:border-t-0 md:border-l border-neutral-200 dark:border-neutral-700"></article>
</section>
</main>
</div>
<template id="itemTemplate">
<button class="w-full text-left p-3 rounded-xl hover:bg-neutral-100 dark:hover:bg-neutral-700 border border-transparent flex flex-col gap-1 relative">
<span class="title font-medium truncate"></span>
<span class="snippet text-xs text-neutral-500 truncate"></span>
<span class="time text-[11px] text-neutral-400"></span>
</button>
</template>
<script>
// 使用模块模式封装代码
const NotionNote = (() => {
  // DOM元素选择器
  const $ = (s) => document.querySelector(s);
  const $$ = (s) => Array.from(document.querySelectorAll(s));
  
  // 常量
  const STORE_KEY = 'notionnote.v1';
  const THEME_KEY = 'notionnote.theme';
  const DEBOUNCE_DELAY = 1000; // 防抖延迟1秒
  const AUTO_SAVE_INTERVAL = 30000; // 自动保存间隔30秒
  
  // 状态管理
  let state = {
    notes: [],
    active: null,
    searchQuery: ''
  };
  
  // 工具函数
  const uid = () => Math.random().toString(36).slice(2, 10);
  const nowISO = () => new Date().toISOString();
  const fmtTime = (iso) => new Date(iso).toLocaleString();
  
  // 防抖函数
  const debounce = (fn, delay) => {
    let timer;
    return (...args) => {
      clearTimeout(timer);
      timer = setTimeout(() => fn(...args), delay);
    };
  };
  
  // 存储操作
  const load = () => {
    try {
      const saved = JSON.parse(localStorage.getItem(STORE_KEY));
      return saved || { notes: [], active: null };
    } catch (e) {
      console.error('加载数据失败:', e);
      return { notes: [], active: null };
    }
  };
  
  const save = () => {
    try {
      localStorage.setItem(STORE_KEY, JSON.stringify({
        notes: state.notes,
        active: state.active
      }));
    } catch (e) {
      console.error('保存数据失败:', e);
    }
  };
  
  const initState = () => {
    const saved = load();
    state.notes = saved.notes || [];
    state.active = saved.active || null;
    
    // 检查URL中是否有分享的笔记
    const urlParams = new URLSearchParams(window.location.search);
    const sharedNote = urlParams.get('n');
    
    if (sharedNote) {
      try {
        const decoded = decodeURIComponent(escape(atob(sharedNote)));
        const payload = JSON.parse(decoded);
        const note = createNote(payload);
        upsertNote(note);
        select(note.id);
        
        // 清除URL参数
        window.history.replaceState({}, document.title, window.location.pathname);
      } catch (e) {
        console.error('解析分享笔记失败:', e);
      }
    } else if (state.active) {
      select(state.active);
    } else if (state.notes.length > 0) {
      select(state.notes[0].id);
    } else {
      // 初始状态没有笔记时创建默认笔记
      const defaultNote = createNote({
        title: '欢迎使用Notion记事本',
        content: '# 欢迎使用Notion记事本\n\n这是一个轻量级的Markdown笔记工具，所有数据都保存在您的浏览器本地。\n\n## 功能特点\n- **实时预览**：右侧可预览Markdown效果\n- **多笔记管理**：左侧可创建和管理多个笔记\n- **本地存储**：数据自动保存到浏览器\n- **分享功能**：可生成分享链接\n\n> 提示：点击左上角"新建"按钮创建更多笔记'
      });
      upsertNote(defaultNote);
      select(defaultNote.id);
    }
  };
  
  // 笔记操作
  const createNote = ({ title = '无标题', content = '' } = {}) => {
    return {
      id: uid(),
      title,
      content,
      created: nowISO(),
      updated: nowISO()
    };
  };
  
  const upsertNote = (note) => {
    const index = state.notes.findIndex(n => n.id === note.id);
    
    if (index >= 0) {
      // 更新现有笔记
      state.notes[index] = {
        ...state.notes[index],
        title: note.title,
        content: note.content,
        updated: nowISO()
      };
    } else {
      // 添加新笔记到开头
      state.notes.unshift(note);
    }
    
    state.active = note.id;
    save();
    renderList();
    highlightActive();
  };
  
  const removeNote = (id) => {
    if (!confirm('确定删除该笔记吗？此操作不可撤销。')) return;
    
    state.notes = state.notes.filter(n => n.id !== id);
    
    if (state.active === id) {
      state.active = state.notes.length > 0 ? state.notes[0].id : null;
    }
    
    save();
    select(state.active);
    renderList();
  };
  
  const select = (id) => {
    if (!id) {
      // 没有笔记时的状态
      $('#title').value = '';
      $('#editor').value = '';
      updatePreview();
      highlightActive();
      return;
    }
    
    const note = state.notes.find(n => n.id === id);
    if (!note) return;
    
    state.active = id;
    save();
    
    $('#title').value = note.title;
    $('#editor').value = note.content;
    updatePreview();
    highlightActive();
  };
  
  // UI渲染
  const renderList = () => {
    const list = $('#list');
    list.innerHTML = '';
    
    if (state.notes.length === 0) {
      list.innerHTML = `
        <div class="text-center py-6">
          <div class="text-sm text-neutral-500 mb-2">没有找到笔记</div>
          <button id="createFirstNote" class="text-sm text-blue-600 hover:underline">
            创建第一个笔记
          </button>
        </div>
      `;
      $('#createFirstNote').addEventListener('click', () => {
        const note = createNote();
        upsertNote(note);
        select(note.id);
      });
      return;
    }
    
    // 筛选笔记
    const q = state.searchQuery.trim().toLowerCase();
    const filteredNotes = q 
      ? state.notes.filter(n => 
          n.title.toLowerCase().includes(q) || 
          n.content.toLowerCase().includes(q))
      : state.notes;
    
    if (filteredNotes.length === 0) {
      list.innerHTML = `
        <div class="text-sm text-neutral-500 p-3">
          没有找到匹配的笔记。尝试修改搜索关键词或
          <button class="text-blue-600 hover:underline" id="clearSearchBtn">
            清除搜索
          </button>
        </div>
      `;
      $('#clearSearchBtn').addEventListener('click', () => {
        $('#search').value = '';
        state.searchQuery = '';
        renderList();
      });
      return;
    }
    
    // 创建文档片段提高性能
    const fragment = document.createDocumentFragment();
    
    filteredNotes.forEach(note => {
      const node = document.importNode($('#itemTemplate').content, true);
      const btn = node.querySelector('button');
      btn.dataset.id = note.id;
      
      node.querySelector('.title').textContent = note.title || '无标题';
      node.querySelector('.snippet').textContent = 
        (note.content || '')
          .replace(/\n/g, ' ')
          .replace(/[#*_\-`>]/g, '') // 移除Markdown标记
          .slice(0, 80);
      
      node.querySelector('.time').textContent = fmtTime(note.updated);
      
      // 添加删除按钮
      const delBtn = document.createElement('button');
      delBtn.innerHTML = '&times;';
      delBtn.className = 'absolute top-2 right-2 w-5 h-5 flex items-center justify-center text-xs text-red-500 hover:bg-red-100 dark:hover:bg-red-900/50 rounded-full';
      delBtn.title = '删除笔记';
      delBtn.addEventListener('click', (e) => {
        e.stopPropagation();
        removeNote(note.id);
      });
      
      btn.appendChild(delBtn);
      btn.addEventListener('click', () => select(note.id));
      
      fragment.appendChild(node);
    });
    
    list.appendChild(fragment);
    highlightActive();
  };
  
  const highlightActive = () => {
    const buttons = $$('#list button');
    buttons.forEach(btn => {
      if (btn.dataset.id === state.active) {
        btn.classList.add('bg-neutral-100', 'dark:bg-neutral-700', 'border-neutral-200', 'dark:border-neutral-600');
      } else {
        btn.classList.remove('bg-neutral-100', 'dark:bg-neutral-700', 'border-neutral-200', 'dark:border-neutral-600');
      }
    });
  };
  
  const updatePreview = () => {
    try {
      const md = $('#editor').value || '';
      $('#preview').innerHTML = marked.parse(md, {
        breaks: true,
        headerIds: false,
        sanitize: true // 防止XSS攻击
      });
    } catch (e) {
      console.error('Markdown解析错误:', e);
      $('#preview').innerHTML = '<p class="text-red-500">Markdown解析出错，请检查语法</p>';
    }
  };
  
  const togglePreview = () => {
    const preview = $('#preview');
    const editor = $('#editor');
    const isPreviewHidden = preview.classList.contains('hidden');
    
    if (isPreviewHidden) {
      preview.classList.remove('hidden');
      editor.classList.remove('md:col-span-2');
      $('#previewToggle').textContent = '隐藏预览';
    } else {
      preview.classList.add('hidden');
      editor.classList.add('md:col-span-2');
      $('#previewToggle').textContent = '预览 Markdown';
    }
  };
  
  // 功能函数
  const makeShareURL = () => {
    const note = state.notes.find(n => n.id === state.active);
    if (!note) return '';
    
    const payload = { 
      t: note.title,
      c: note.content,
      d: new Date().toISOString().slice(0, 10) // 添加日期标识
    };
    
    try {
      const json = JSON.stringify(payload);
      const packed = btoa(unescape(encodeURIComponent(json)));
      const url = new URL(location.href);
      url.searchParams.set('n', packed);
      return url.toString();
    } catch (e) {
      console.error('生成分享链接失败:', e);
      return '';
    }
  };
  
  const importMarkdown = (file) => {
    const reader = new FileReader();
    reader.onload = () => {
      const title = file.name.replace(/\.md$/i, '') || '导入的笔记';
      const content = reader.result;
      
      // 创建新笔记而不是覆盖当前笔记
      const note = createNote({ title, content });
      upsertNote(note);
      select(note.id);
    };
    
    reader.onerror = () => {
      alert('文件读取失败，请重试');
    };
    
    reader.readAsText(file);
  };
  
  const exportMarkdown = () => {
    const note = state.notes.find(n => n.id === state.active);
    if (!note) return;
    
    const content = note.content;
    const title = note.title.replace(/[^\w\u4e00-\u9fa5]/g, '_') || '未命名笔记';
    
    try {
      const blob = new Blob([content], { type: 'text/markdown' });
      const a = document.createElement('a');
      a.href = URL.createObjectURL(blob);
      a.download = `${title}.md`;
      a.click();
      URL.revokeObjectURL(a.href);
    } catch (e) {
      console.error('导出失败:', e);
      alert('导出失败，请重试');
    }
  };
  
  const initTheme = () => {
    const saved = localStorage.getItem(THEME_KEY);
    const html = document.documentElement;
    
    if (saved === 'dark') {
      html.classList.add('dark');
    } else if (saved === 'light') {
      html.classList.remove('dark');
    } else {
      // 跟随系统偏好
      const isDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
      if (isDark) html.classList.add('dark');
    }
  };
  
  const toggleTheme = () => {
    const html = document.documentElement;
    const isDark = html.classList.contains('dark');
    
    if (isDark) {
      html.classList.remove('dark');
      localStorage.setItem(THEME_KEY, 'light');
    } else {
      html.classList.add('dark');
      localStorage.setItem(THEME_KEY, 'dark');
    }
  };
  
  // 事件绑定
  const bindEvents = () => {
    // 笔记操作
    $('#newBtn').addEventListener('click', () => {
      const note = createNote();
      upsertNote(note);
      select(note.id);
    });
    
    $('#deleteBtn').addEventListener('click', () => {
      if (state.active) removeNote(state.active);
    });
    
    // 导入导出
    $('#exportBtn').addEventListener('click', exportMarkdown);
    $('#importInput').addEventListener('change', e => {
      if (e.target.files[0]) importMarkdown(e.target.files[0]);
    });
    
    // 预览
    $('#previewToggle').addEventListener('click', togglePreview);
    
    // 分享
    $('#shareBtn').addEventListener('click', async () => {
      const link = makeShareURL();
      if (!link) {
        alert('无法生成分享链接');
        return;
      }
      
      try {
        await navigator.clipboard.writeText(link);
        $('#shareBtn').textContent = '已复制链接';
        setTimeout(() => {
          if ($('#shareBtn')) $('#shareBtn').textContent = '复制分享链接';
        }, 1500);
      } catch {
        prompt('复制失败，请手动复制链接：', link);
      }
    });
    
    // 主题
    $('#themeToggle').addEventListener('click', toggleTheme);
    
    // 搜索
    $('#search').addEventListener('input', debounce((e) => {
      state.searchQuery = e.target.value;
      renderList();
    }, 300));
    
    // 标题和内容编辑
    const saveChanges = debounce(() => {
      if (!state.active) {
        // 如果没有活动笔记，创建新笔记
        const note = createNote({
          title: $('#title').value.trim() || '无标题',
          content: $('#editor').value
        });
        upsertNote(note);
        return;
      }
      
      const note = state.notes.find(n => n.id === state.active);
      if (!note) return;
      
      note.title = $('#title').value.trim() || '无标题';
      note.content = $('#editor').value;
      note.updated = nowISO();
      
      save();
      renderList();
      highlightActive();
    }, DEBOUNCE_DELAY);
    
    $('#title').addEventListener('input', saveChanges);
    $('#editor').addEventListener('input', () => {
      updatePreview();
      saveChanges();
    });
    
    // 自动保存保险
    setInterval(() => {
      if (state.active) saveChanges();
    }, AUTO_SAVE_INTERVAL);
    
    // 处理浏览器关闭前的保存
    window.addEventListener('beforeunload', (e) => {
      if (state.active) saveChanges.flush();
    });
  };
  
  // 初始化应用
  const init = () => {
    initTheme();
    initState();
    bindEvents();
    renderList();
    updatePreview();
    
    // 添加键盘快捷键
    document.addEventListener('keydown', (e) => {
      // Cmd/Ctrl + K 聚焦搜索框
      if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
        e.preventDefault();
        $('#search').focus();
      }
    });
  };
  
  // 公共API
  return {
    init
  };
})();

// 启动应用
document.addEventListener('DOMContentLoaded', NotionNote.init);
</script>
</body>
</html>
